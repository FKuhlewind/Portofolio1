<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="tomorrow-night.css" />
    <link rel="stylesheet" type="text/css" href="tooltipster.css" />
</head>

<body>

<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="prettify.js"></script>
<script type="text/javascript" src="tooltipster.js"></script>
<script type="text/javascript" src="codecode.js"></script>

<div class="codeTop">
	<div class="codeLeft">// Code for the extended Assignment #4/5 <a href="https://github.com/FKuhlewind/Portofolio1/blob/gh-pages/code-asg4.js" target="_blank">(code-asg4.js)</a></div>
	<div class="codeRight">
		<div class="codeButton1"><div class="dIn"><a href="https://gist.github.com/FKuhlewind/9939695" target="_blank">Initial Assignment</a></div></div>
		<div class="codeButton2"><div class="dIn">Enable Tooltips</div></div>
	</div>
</div>


<pre><code class="prettyprint">$(document).ready(function() { 

// check localStorage and choose font accordingly
$('body, #onRight').css({'font-family':localStorage.myFont});
$("#background").css({'background-color':localStorage.myColor+'0.2)'});
$("button").css({'background-color':localStorage.myColor+'0.6)'});

<span class="yell" title="Define size and padding of the diagram.">var width = 360;</span> 
var height = 360;
var padding = 45;
<span class="yell" title="This value adds some additional space to the axis to avoid datapoints to overlap with the axis ('0.1' means: add 10%).">var addToAxis = 0.1;</span>  
xD = 4; yD = 5; // define values to display initially
myDataRef = new Firebase('https://vib-data.firebaseio.com/');

// define functions
<span class="yell" title="This defines the display range of the axis...">function getDisplayRange</span> () {
	// calculate display range for axis
	xExt = d3.extent(vibData[xD], function(d) { return d;});
	<span class="yell" title="...based on min and max values of the data object...">yExt = d3.extent(vibData[yD], function(d)</span> { return d;});
	fromX = xExt[0] - ( (xExt[1]-xExt[0]) * addToAxis );
	toX = xExt[1] + ( (xExt[1]-xExt[0]) * addToAxis );
	<span class="yell" title="...and adding some additional axis space on top.">fromY = yExt[0] - ( (yExt[1]-yExt[0]) * addToAxis );</span> 
	toY = yExt[1] + ( (yExt[1]-yExt[0]) * addToAxis );
	};
	
function getData () {
	// get data and label variables
	xyData = [];
	<span class="yell" title="Here we sort our data by iterating over the original array and storing it in xyData so it can be bound to the objects easier.">for ( var i = 0, l = 10; i < l; i++ )</span> {
    		xyData[i]= [vibData[xD][i], vibData[yD][i]] };
	xLabel = vibData[xD][10];
	<span class="yell" title="This stores the label information attached to the data values.">yLabel = vibData[yD][10];</span>
	};
	
function updateScaleDomains () {
	<span class="yell" title="Scale domains are defined...">xScale = d3.scale.linear()</span> 
    		.domain([fromX, toX])
    		.range([padding, width-(padding)]);
	yScale = d3.scale.linear()
    		.domain([fromY, toY])
    		.range([height-padding, padding]);
	};
	
function defineXYaxis () {
	xAxis = d3.svg.axis()
    		.scale(xScale)
    		.orient("bottom")
    		.ticks(5);
	<span class="yell" title="...and applied to the axis.">yAxis = d3.svg.axis()</span> 
    		.scale(yScale)
    		.orient("left")
    		.ticks(5);
	};
	
<span class="yell" title="This function creates the dropdown menu needed to display different data based on information stored in Firebase.">function createForm ()</span> {

	<span class="yell" title="First, we remove the existing dropdown menus.">$("#xAxisChoice option, #yAxisChoice option").remove();</span>

	<span class="yell" title="Once the data has been loaded from Firebase...">d3.json('https://vib-data.firebaseio.com/.json', function(data)</span>  {
		vibData = data; 
		// update dropdown menu
		a = '';
		<span class="yell" title="...we iterate over each entry and concatenate the option tags for the dropdown menu and apply the respective index and value to the elements.">$.each( vibData , function( index, value )</span>  {
  			a = a.concat('<option value='+index+'>'+value[10]+'</option>');
			});
		<span class="yell" title="Finally we append the option tags to both the x and y axis dropdown menus.">$("#xAxisChoice, #yAxisChoice").append(a);</span>

		// enable update
		<span class="yell" title="If the user clicks on 'Update',...">$("#vibUpdate").on("click", function(e)</span> {

			e.preventDefault();
			e.stopPropagation();

			// get info on which values to display on Axis
			<span class="yell" title="... the selected values of the menu are referenced to display the correct data,...">xD = $("#xAxisChoice").val();</span>
			yD = $("#yAxisChoice").val();

			getDisplayRange();
			getData();
			updateScaleDomains();
			<span class="yell" title="...new display ranges and scale domains get defined...">defineXYaxis();</span>

			//update circles
			<span class="yell" title="...and the SVG is updated with new values.">mySVG.selectAll("circle")</span>
		    		.data(xyData)
		    		<span class="yell" title="These lines call a transition to the new data values..."> .transition()</span>
		    		.duration(1000)
		    		.attr("cx", function(d) {
		                	return xScale(d[0]);})
		    		<span class="yell" title="...along with the transition duration and assigning the values to which the transition should be applied."> .attr("cy", function(d)</span> {
		            		return yScale(d[1]);});

			//update x and y axis
			<span class="yell" title="We also need to update the axis...">mySVG.select(".x.axis")</span>
		    		.transition()
		    		.duration(500)
		    		.call(xAxis);
		    	mySVG.select(".y.axis")
		    		.transition()
		    		.duration(500)
		    		.call(yAxis);

			//update text labels
			mySVG.select(".x.text")
				<span class="yell" title="...and add the new axis labels.">.text(xLabel)</span>
		    		.transition()
		    		.duration(1000);

		    	mySVG.select(".y.text")
		    		.transition()
		    		.duration(1000)
		    		.text(yLabel);
			});
		});
	};
	
// start of script

d3.json('https://vib-data.firebaseio.com/.json', function(data) {

	$("svg").remove();

	vibData = data;
	getDisplayRange();
	getData();
	updateScaleDomains();
	defineXYaxis();
<!--    <span class="yell" title="">       </span>   -->
	// create svg 
	mySVG = d3.select(".here")
	  .append("svg")
	  .attr("width", width)
	  .attr("height", height);

	// update color from local storage
	$("svg").css({'background-color':localStorage.myColor+'0.3)'});

	// create circles
	mySVG.selectAll("circle")
	  .data(xyData)
	  .enter()
	  .append("circle")
	  .attr("cx", function(d) {
                return xScale(d[0]);})
    	  .attr("cy", function(d) {
            	return yScale(d[1]);})
    	  .attr("r", 3);

	// create X axis
	mySVG.append("g")
    	  .attr("class", "x axis")	
    	  .attr("transform", "translate(0," + (height - padding) + ")")
    	  .style({ 'stroke': 'Black', 'fill': 'none', 'stroke-width': '1px', 'font-family':'Arial', 'font-size':'10px'})
    	  .call(xAxis);
	// create Y axis
	mySVG.append("g")
    	  .attr("class", "y axis")
    	  .attr("transform", "translate(" + padding + ",0)")
    	  .style({ 'stroke': 'Black', 'fill': 'none', 'stroke-width': '1px', 'font-family':'Arial', 'font-size':'10px'})
    	  .call(yAxis);

	// create axis labels and main title
	mySVG.append("text")
          .attr("x", width/2 )
          .attr("y", padding/2 )
          .style("text-anchor", "middle")
          .text("Vibrato Analysis")
          .style({ 'stroke': 'Black', 'fill': 'none', 'stroke-width': '1px', 'font-family':'Arial', 'font-size':'14px' });
	mySVG.append("text")
	  .attr("class", "x text")
          .attr("x", width/2 )
          .attr("y", height-(padding/4) )
          .style("text-anchor", "middle")
          .text(xLabel)
          .style({ 'stroke': 'Black', 'fill': 'none', 'stroke-width': '1px', 'font-family':'Arial', 'font-size':'12px' });
	mySVG.append("text")
	  .attr("class", "y text")
	  .text(yLabel)
          .attr("x", padding/4)
          .attr("y", height/2)
          .style("text-anchor", "middle")
          .style({ 'stroke': 'Black', 'fill': 'none', 'stroke-width': '1px', 'font-family':'Arial', 'font-size':'12px' })
          .style("writing-mode", "tb");

	// creates update form
	createForm();

	// store new data
	$("#storeData")
		.on("click", function(e) {

			e.preventDefault();
			e.stopPropagation();

			n = vibData.length;

			for ( var i = 0, l = 10; i < l; i++ ) {
				p = i + 1;
    				myDataRef.child(n).child(i).set( parseInt( $("#val"+p).val()) );
    				};
			myDataRef.child(n).child(10).set( $("#newLabel").val() );

			createForm();
			$('#newValues :input').val('');

			d3.json('https://vib-data.firebaseio.com/.json', function(data) {
				vibData = data; 
				alert("New data stored successfully, you can now select it from the dropdown menu/
				       above to be displayed");
				});
		});
});
});
</code></pre>
</body>
</html>
